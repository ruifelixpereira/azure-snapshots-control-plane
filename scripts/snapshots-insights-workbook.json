{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 1,
      "content": {
        "json": "# Azure Snapshots Insights\r\nUse this workbook to analyze and monitor all your Azure Snapshot resources."
      },
      "name": "text - Main"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "crossComponentResources": [
          "{Subscription}"
        ],
        "parameters": [
          {
            "id": "1f74ed9a-e3ed-498d-bd5b-f68f3836a117",
            "version": "KqlParameterItem/1.0",
            "name": "Subscription",
            "type": 6,
            "description": "All subscriptions with Snapshots",
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "where type =~ \"microsoft.compute/snapshots\"\r\n| summarize Count = count() by subscriptionId\r\n| order by Count desc\r\n| extend Rank = row_number()\r\n| project value = subscriptionId, label = subscriptionId, selected = Rank == 1",
            "crossComponentResources": [
              "value::selected"
            ],
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "showDefault": false
            },
            "queryType": 1,
            "value": [
              "/subscriptions/111-111-111"
            ]
          },
          {
            "id": "df4a3e18-45e6-41fd-ab9b-903226867436",
            "version": "KqlParameterItem/1.0",
            "name": "ResourceGroup",
            "label": " Resource Group",
            "type": 5,
            "description": "All Resource Groups",
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "where type == 'microsoft.compute/snapshots'\r\n| summarize Count = count() by resourceGroup\r\n| order by Count desc\r\n| extend Rank = row_number()\r\n| project value = resourceGroup, label = resourceGroup, selected = Rank == 1",
            "crossComponentResources": [
              "{Subscription}"
            ],
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "showDefault": false
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "value": [
              "xpto"
            ]
          },
          {
            "id": "f60ea0a0-3703-44ca-a59b-df0246423f41",
            "version": "KqlParameterItem/1.0",
            "name": "Snapshots",
            "type": 5,
            "description": "All Snapshots",
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "where type =~ 'microsoft.compute/snapshots'\r\n| where resourceGroup in ({ResourceGroup:value})\r\n| order by name asc\r\n| extend Rank = row_number()\r\n| project value = id, label = id, selected = Rank <= 5",
            "crossComponentResources": [
              "{Subscription}"
            ],
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "showDefault": false
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "value": [
              "value::all"
            ]
          },
          {
            "id": "029a03e0-bbe8-49ab-929f-c1026d1b8e40",
            "version": "KqlParameterItem/1.0",
            "name": "SnapshotAge",
            "label": "Time Range",
            "type": 4,
            "description": "This allow you to filter snapshot by time created.",
            "isRequired": true,
            "typeSettings": {
              "selectableValues": [
                {
                  "durationMs": 86400000
                },
                {
                  "durationMs": 172800000
                },
                {
                  "durationMs": 259200000
                },
                {
                  "durationMs": 604800000
                },
                {
                  "durationMs": 1209600000
                },
                {
                  "durationMs": 2419200000
                },
                {
                  "durationMs": 2592000000
                },
                {
                  "durationMs": 5184000000
                },
                {
                  "durationMs": 7776000000
                }
              ],
              "allowCustom": true
            },
            "value": {
              "durationMs": 86400000
            }
          },
          {
            "id": "4b6b8f2a-c2cc-4740-98e8-f4ce08650601",
            "version": "KqlParameterItem/1.0",
            "name": "EnableDeletion",
            "label": "Enable Deletion",
            "type": 2,
            "description": "By default, this feature is disabled. Enable it to allow resource deletion.",
            "isRequired": true,
            "query": "{\"version\":\"1.0.0\",\"content\":\"[\\r\\n    {\\\"value\\\": \\\"false\\\", \\\"label\\\": \\\"Disable\\\", \\\"selected\\\":true},    \\r\\n\\t{\\\"value\\\": \\\"true\\\", \\\"label\\\": \\\"Enable\\\"}\\r\\n]\",\"transformers\":null}",
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "queryType": 8
          },
          {
            "id": "ca79f268-3857-4ac7-a7ae-a0dd21e309a2",
            "version": "KqlParameterItem/1.0",
            "name": "LogAnalyticsWorkspace",
            "label": "Log Analytics Workspace",
            "type": 5,
            "description": "All Log Analytics Workspaces",
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "where type == 'microsoft.operationalinsights/workspaces'\r\n| summarize Count = count() by id\r\n| order by Count desc\r\n| extend Rank = row_number()\r\n| project value = id, label = id, selected = Rank == 1",
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "showDefault": false
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "value": [
              "/subscriptions/111-111-111/resourceGroups/xpto/providers/Microsoft.OperationalInsights/workspaces/law-01"
            ]
          }
        ],
        "style": "above",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources"
      },
      "name": "Workbook Parameters",
      "styleSettings": {
        "margin": "15px 0 0 0"
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "template",
        "loadFromTemplateId": "community-Workbooks/Common/noSubscriptions",
        "items": []
      },
      "conditionalVisibility": {
        "parameterName": "Subscription",
        "comparison": "isEqualTo",
        "value": ""
      },
      "name": "No Subscriptions group"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "tabs",
              "links": [
                {
                  "id": "311bebc4-f846-40e2-92a7-6e6e28ad5ba4",
                  "cellValue": "selectedTab",
                  "linkTarget": "parameter",
                  "linkLabel": "Summary",
                  "subTarget": "Summary",
                  "style": "link"
                },
                {
                  "id": "8eeff79e-c814-4bed-9994-86dd43352688",
                  "cellValue": "selectedTab",
                  "linkTarget": "parameter",
                  "linkLabel": "Virtual Machines",
                  "subTarget": "VirtualMachines",
                  "style": "link"
                },
                {
                  "id": "8f323073-4275-4c81-823c-1d9e2a55c55f",
                  "cellValue": "selectedTab",
                  "linkTarget": "parameter",
                  "linkLabel": "Snapshots",
                  "subTarget": "Snapshots",
                  "style": "link"
                },
                {
                  "id": "4a9ecfa7-e64f-42b8-aa35-06f2cdc26086",
                  "cellValue": "selectedTab",
                  "linkTarget": "parameter",
                  "linkLabel": "Inventory",
                  "subTarget": "Inventory",
                  "style": "link"
                },
                {
                  "id": "ed01c8a5-bc00-4244-984c-f269936d4001",
                  "cellValue": "selectedTab",
                  "linkTarget": "parameter",
                  "linkLabel": "Backup Jobs",
                  "subTarget": "BackupJobs",
                  "style": "link"
                },
                {
                  "id": "d83d2537-d434-4347-ad73-fccb68d04b90",
                  "cellValue": "selectedTab",
                  "linkTarget": "parameter",
                  "linkLabel": "Purge Jobs",
                  "subTarget": "PurgeJobs",
                  "style": "link"
                }
              ]
            },
            "name": "links - Navigation links",
            "styleSettings": {
              "margin": "10px 0 0 0"
            }
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "bullets",
              "links": []
            },
            "name": "links - 3"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "### Azure Snapshots Dashboard\r\n\r\nOverview dashboard for Azure Snaphots.\r\n",
                    "style": "upsell"
                  },
                  "name": "text - Main Title"
                },
                {
                  "type": 9,
                  "content": {
                    "version": "KqlParameterItem/1.0",
                    "parameters": [
                      {
                        "id": "e6108487-636b-4557-a650-9c979f63e9f8",
                        "version": "KqlParameterItem/1.0",
                        "name": "SnapshotNameFilter",
                        "label": "Snapshot Name",
                        "type": 1,
                        "description": "Filter the snapshots by name",
                        "typeSettings": {
                          "isSearchBox": true
                        },
                        "timeContext": {
                          "durationMs": 86400000
                        }
                      },
                      {
                        "id": "cf868eb7-4a58-4cf0-b7bc-47d64a4a9bca",
                        "version": "KqlParameterItem/1.0",
                        "name": "LocationFilter",
                        "type": 2,
                        "multiSelect": true,
                        "quote": "'",
                        "delimiter": ",",
                        "typeSettings": {
                          "additionalResourceOptions": [],
                          "showDefault": false
                        },
                        "jsonData": "[\r\n    { \"value\":\"primary\", \"label\": \"primary\"},\r\n    { \"value\":\"secondary\", \"label\": \"secondary\"}\r\n]",
                        "timeContext": {
                          "durationMs": 86400000
                        },
                        "value": [
                          "primary",
                          "secondary"
                        ],
                        "label": "Location Type"
                      },
                      {
                        "id": "592ccd59-e0dd-4a3b-96bf-5c8b07a6e069",
                        "version": "KqlParameterItem/1.0",
                        "name": "ProvisioningStateFilter",
                        "label": "Provisioning State",
                        "type": 2,
                        "multiSelect": true,
                        "quote": "'",
                        "delimiter": ",",
                        "query": "resources \r\n| where type == \"microsoft.compute/snapshots\"\r\n| extend provisioningState = tostring(properties.provisioningState)\r\n| distinct provisioningState\r\n| project provisioningState",
                        "typeSettings": {
                          "additionalResourceOptions": []
                        },
                        "timeContext": {
                          "durationMs": 86400000
                        },
                        "queryType": 1,
                        "resourceType": "microsoft.resourcegraph/resources",
                        "value": [
                          "Failed"
                        ]
                      }
                    ],
                    "style": "above",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces"
                  },
                  "name": "Snaphots - parameters"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "resources \r\n| where type == \"microsoft.compute/snapshots\"\r\n| where resourceGroup in~ ({ResourceGroup:value})\r\n| where name in~ (split(\"{Snapshots:label}\", \", \"))\r\n| where isempty('{SnapshotNameFilter}') or tolower(name) contains tolower(tostring('{SnapshotNameFilter}'))\r\n| extend TimeCreated = properties.timeCreated\r\n| extend snapshotType = case(properties.incremental == true, \"Incremental\", properties.incremental == false, \"Full\", \"\")\r\n| extend locationType = tags['smcp-location-type']\r\n| where TimeCreated >= {SnapshotAge:start} and TimeCreated <= {SnapshotAge:end}\r\n| where locationType in~ (split(\"{LocationFilter:label}\", \", \"))\r\n| extend provisioningState = tostring(properties.provisioningState)\r\n| where provisioningState in~ (split(\"{ProvisioningStateFilter:label}\", \", \"))\r\n| extend Details = pack_all()\r\n| project id, sourceDisk = properties.creationData.sourceResourceId, diskSizeGB = properties.diskSizeGB, resourceGroup, location, apiVersion, sku = sku.name, snapshotType, TimeCreated, publicNetworkAccess = properties.publicNetworkAccess, networkAccessPolicy = properties.networkAccessPolicy, subscriptionId, provisioningState, locationType, tags, Details",
                    "size": 3,
                    "exportMultipleValues": true,
                    "exportedParameters": [
                      {
                        "fieldName": "id",
                        "parameterName": "resources",
                        "parameterType": 5
                      }
                    ],
                    "showExportToExcel": true,
                    "queryType": 1,
                    "resourceType": "microsoft.resourcegraph/resources",
                    "crossComponentResources": [
                      "{Subscription}"
                    ],
                    "visualization": "table",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "$gen_group",
                          "formatter": 13,
                          "formatOptions": {
                            "linkTarget": "Resource",
                            "linkIsContextBlade": false,
                            "showIcon": true
                          }
                        },
                        {
                          "columnMatch": "id",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "sourceDisk",
                          "formatter": 13,
                          "formatOptions": {
                            "linkTarget": "Resource",
                            "showIcon": true
                          }
                        },
                        {
                          "columnMatch": "diskSizeGB",
                          "formatter": 1,
                          "formatOptions": {
                            "copilotNudgeActionSettings": {
                              "nudgeContent": "What is the properties of this [\"id\"]"
                            }
                          }
                        },
                        {
                          "columnMatch": "location",
                          "formatter": 17
                        },
                        {
                          "columnMatch": "apiVersion",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "sku",
                          "formatter": 1
                        },
                        {
                          "columnMatch": "TimeCreated",
                          "formatter": 6
                        },
                        {
                          "columnMatch": "publicNetworkAccess",
                          "formatter": 18,
                          "formatOptions": {
                            "thresholdsOptions": "icons",
                            "thresholdsGrid": [
                              {
                                "operator": "==",
                                "thresholdValue": "Enabled",
                                "representation": "Globe",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "Default",
                                "thresholdValue": null,
                                "representation": "Disable",
                                "text": "{0}{1}"
                              }
                            ]
                          }
                        },
                        {
                          "columnMatch": "networkAccessPolicy",
                          "formatter": 18,
                          "formatOptions": {
                            "thresholdsOptions": "icons",
                            "thresholdsGrid": [
                              {
                                "operator": "==",
                                "thresholdValue": "AllowAll",
                                "representation": "Globe",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "==",
                                "thresholdValue": "AllowPrivate",
                                "representation": "Lock",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "Default",
                                "thresholdValue": null,
                                "representation": "Disable",
                                "text": "{0}{1}"
                              }
                            ]
                          }
                        },
                        {
                          "columnMatch": "subscriptionId",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "Details",
                          "formatter": 7,
                          "formatOptions": {
                            "linkTarget": "CellDetails",
                            "linkLabel": "ðŸ” View Details",
                            "linkIsContextBlade": true
                          }
                        },
                        {
                          "columnMatch": "diskState",
                          "formatter": 1
                        },
                        {
                          "columnMatch": "incremental",
                          "formatter": 1
                        },
                        {
                          "columnMatch": "createOption",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "size",
                          "formatter": 1
                        },
                        {
                          "columnMatch": "tier",
                          "formatter": 1
                        },
                        {
                          "columnMatch": "status",
                          "formatter": 1
                        },
                        {
                          "columnMatch": "numberOfSites",
                          "formatter": 1
                        },
                        {
                          "columnMatch": "instances",
                          "formatter": 1
                        },
                        {
                          "columnMatch": "maximumNumberOfWorkers",
                          "formatter": 1
                        }
                      ],
                      "rowLimit": 50,
                      "hierarchySettings": {
                        "treeType": 1,
                        "groupBy": [
                          "subscriptionId"
                        ],
                        "expandTopLevel": true,
                        "finalBy": "id"
                      },
                      "sortBy": [
                        {
                          "itemKey": "diskSizeGB",
                          "sortOrder": 1
                        }
                      ],
                      "labelSettings": [
                        {
                          "columnId": "id",
                          "label": "Name"
                        },
                        {
                          "columnId": "sourceDisk",
                          "label": "Source"
                        },
                        {
                          "columnId": "diskSizeGB",
                          "label": "Source size (GiB)"
                        },
                        {
                          "columnId": "resourceGroup",
                          "label": "Resource Group"
                        },
                        {
                          "columnId": "location",
                          "label": "Location"
                        },
                        {
                          "columnId": "apiVersion",
                          "label": "Api Version"
                        },
                        {
                          "columnId": "sku",
                          "label": "Storage type"
                        },
                        {
                          "columnId": "snapshotType",
                          "label": "Snapshot type"
                        },
                        {
                          "columnId": "TimeCreated",
                          "label": "Time created"
                        },
                        {
                          "columnId": "publicNetworkAccess",
                          "label": "Public Network Access"
                        },
                        {
                          "columnId": "networkAccessPolicy",
                          "label": "Network Access Policy"
                        },
                        {
                          "columnId": "subscriptionId",
                          "label": "Subscription"
                        },
                        {
                          "columnId": "provisioningState",
                          "label": "Provisioning State"
                        },
                        {
                          "columnId": "locationType",
                          "label": "Location Type"
                        },
                        {
                          "columnId": "tags",
                          "label": "Tags"
                        },
                        {
                          "columnId": "Details",
                          "label": "Details"
                        }
                      ]
                    },
                    "sortBy": [
                      {
                        "itemKey": "diskSizeGB",
                        "sortOrder": 1
                      }
                    ]
                  },
                  "name": "query - All Snaps"
                },
                {
                  "type": 12,
                  "content": {
                    "version": "NotebookGroup/1.0",
                    "groupType": "editable",
                    "items": [
                      {
                        "type": 1,
                        "content": {
                          "json": "### Delete Resource(s)\r\n\r\nTo delete resource(s), select the resource(s) from the table above and click the `â›” Delete Selected Resource(s)` button below.",
                          "style": "info"
                        },
                        "name": "text - Delete Multiple Resources"
                      },
                      {
                        "type": 11,
                        "content": {
                          "version": "LinkItem/1.0",
                          "style": "list",
                          "links": [
                            {
                              "id": "93355de1-d3fe-4100-b3fd-60afe2ef5a4b",
                              "cellValue": "{resources}",
                              "linkTarget": "ArmAction",
                              "linkLabel": "â›” Delete Selected Resource(s)",
                              "style": "primary",
                              "linkIsContextBlade": true,
                              "armActionContext": {
                                "path": "/{resources}",
                                "headers": [],
                                "params": [
                                  {
                                    "key": "api-version",
                                    "value": "2021-04-01"
                                  }
                                ],
                                "isLongOperation": true,
                                "httpMethod": "DELETE",
                                "applyToMultipleResourcesParameter": "resources",
                                "title": "Delete Resources",
                                "description": "# â›” **Attention!** â›”\n\n## This action will permanently delete the following snapshot(s):\n\n{resources:grid}\n\n\n### Recommended steps before deletion\n\n- Review the resource(s) information thoroughly before continuing with the deletion.\n- Ensure that the resource(s) is not currently in use.\n\n\n### Required Permissions\n\n- To complete this action, you must have _Contributor_ permissions for the Resource Groups where the resource(s) are located.",
                                "actionName": "Delete Resources",
                                "runLabel": "Delete Resources"
                              }
                            }
                          ]
                        },
                        "name": "links - Delete Multiple Resources"
                      }
                    ]
                  },
                  "conditionalVisibility": {
                    "parameterName": "EnableDeletion",
                    "comparison": "isEqualTo",
                    "value": "true"
                  },
                  "name": "group - Delete Multiple Resources"
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "selectedTab",
              "comparison": "isEqualTo",
              "value": "Snapshots"
            },
            "name": "group - Snapshots Group"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "### Virtual Machines Dashboard\r\n\r\nOverview of Virtual Machines and the level of snapshots backup protection.\r\n",
                    "style": "upsell"
                  },
                  "name": "text - Main Title"
                },
                {
                  "type": 9,
                  "content": {
                    "version": "KqlParameterItem/1.0",
                    "crossComponentResources": [
                      "/subscriptions/111-111-111/resourceGroups/xpto"
                    ],
                    "parameters": [
                      {
                        "id": "4d5893ee-ae49-4a9a-be91-7d11cf4b8eb2",
                        "version": "KqlParameterItem/1.0",
                        "name": "VmName",
                        "label": "Virtual Machine Name",
                        "type": 1,
                        "description": "Filter VMs by name",
                        "typeSettings": {
                          "isSearchBox": true
                        },
                        "timeContext": {
                          "durationMs": 86400000
                        }
                      }
                    ],
                    "style": "above",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces"
                  },
                  "name": "vm - parameters"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "resources\r\n| where type == 'microsoft.compute/virtualmachines'\r\n| where resourceGroup in~ ({ResourceGroup:value})\r\n| where isempty('{VmName:value}') or tolower(name) contains tolower(tostring('{VmName:value}'))\r\n| extend backupActive = coalesce(tolower(tostring(tags[\"smcp-backup\"])), \"off\")\r\n| extend osDiskId = tolower(tostring(properties.storageProfile.osDisk.managedDisk.id))\r\n| extend vmSize = tostring(properties.hardwareProfile.vmSize)\r\n| join kind=inner (\r\nÂ Â Â  resources\r\nÂ Â Â  | where type == \"microsoft.compute/disks\"\r\n    | extend diskId = tolower(id)\r\n    | extend diskSku = tostring(sku.name)\r\n    | extend diskSizeGB = tostring(properties.diskSizeGB)\r\n) on $left.osDiskId == $right.diskId\r\n| project id, name, location, resourceGroup, subscriptionId, vmSize, osDiskId, diskName = name1, diskSku, diskSizeGB, backupActive",
                    "size": 3,
                    "exportFieldName": "diskName",
                    "exportParameterName": "SelectedDisk",
                    "showExportToExcel": true,
                    "queryType": 1,
                    "resourceType": "microsoft.resourcegraph/resources",
                    "crossComponentResources": [
                      "{LogAnalyticsWorkspace}"
                    ],
                    "visualization": "table",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "name",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "subscriptionId",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "diskName",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "TimeGenerated",
                          "formatter": 6,
                          "dateFormat": {
                            "showUtcTime": null,
                            "formatName": "shortDateTimeNoMsPattern"
                          }
                        },
                        {
                          "columnMatch": "jobStatus",
                          "formatter": 18,
                          "formatOptions": {
                            "thresholdsOptions": "icons",
                            "thresholdsGrid": [
                              {
                                "operator": "==",
                                "thresholdValue": "Purge Completed",
                                "representation": "success",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "==",
                                "thresholdValue": "Purge In Progress",
                                "representation": "pending",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "==",
                                "thresholdValue": "Purge Failed",
                                "representation": "3",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "Default",
                                "thresholdValue": null,
                                "representation": "unknown",
                                "text": "{0}{1}"
                              }
                            ]
                          }
                        },
                        {
                          "columnMatch": "DurationMinutes",
                          "formatter": 0,
                          "numberFormat": {
                            "unit": 25,
                            "options": {
                              "style": "decimal",
                              "maximumFractionDigits": 1
                            }
                          }
                        }
                      ],
                      "rowLimit": 50,
                      "labelSettings": [
                        {
                          "columnId": "id",
                          "label": "Virtual Machine"
                        },
                        {
                          "columnId": "location",
                          "label": "Location"
                        },
                        {
                          "columnId": "resourceGroup",
                          "label": "Resource Group"
                        },
                        {
                          "columnId": "vmSize",
                          "label": "Size"
                        },
                        {
                          "columnId": "osDiskId",
                          "label": "OS Disk"
                        },
                        {
                          "columnId": "diskName",
                          "label": "Disk Name"
                        },
                        {
                          "columnId": "diskSku",
                          "label": "Disk Sku"
                        },
                        {
                          "columnId": "diskSizeGB",
                          "label": "Disk Size GB"
                        },
                        {
                          "columnId": "backupActive",
                          "label": "Backup Active"
                        }
                      ]
                    },
                    "sortBy": []
                  },
                  "name": "query - All Purge Jobs"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "resources \r\n| where type == \"microsoft.compute/snapshots\"\r\n| extend expectedSnapshotName = strcat(\"-\", \"{SelectedDisk}\")\r\n| where name contains expectedSnapshotName\r\n| where resourceGroup in~ ({ResourceGroup:value})\r\n| extend TimeCreated = todatetime(properties.timeCreated)\r\n| extend snapshotType = case(properties.incremental == true, \"Incremental\", properties.incremental == false, \"Full\", \"\")\r\n| extend snapshotType2 = case(name endswith \"-sec\", \"Secondary Backup\", \"Primary Backup\")\r\n| where TimeCreated >= {SnapshotAge:start} and TimeCreated <= {SnapshotAge:end}\r\n| extend Details = pack_all()\r\n| project TimeCreated, id, name, sourceDisk = properties.creationData.sourceResourceId, diskSizeGB = properties.diskSizeGB, resourceGroup, location, apiVersion, sku = sku.name, snapshotType, snapshotType2, publicNetworkAccess = properties.publicNetworkAccess, networkAccessPolicy = properties.networkAccessPolicy, subscriptionId, tags, Details\r\n| sort by TimeCreated",
                    "size": 0,
                    "title": "Virtual Machine OS Disk Snapshots",
                    "queryType": 1,
                    "resourceType": "microsoft.resourcegraph/resources",
                    "crossComponentResources": [
                      "{LogAnalyticsWorkspace}"
                    ],
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "$gen_group",
                          "formatter": 17,
                          "formatOptions": {
                            "customColumnWidthSetting": "120px"
                          }
                        },
                        {
                          "columnMatch": "TimeCreated",
                          "formatter": 6,
                          "dateFormat": {
                            "showUtcTime": null,
                            "formatName": "shortDateTimeNoMsPattern"
                          }
                        },
                        {
                          "columnMatch": "name",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "sourceDisk",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "diskSizeGB",
                          "formatter": 2
                        },
                        {
                          "columnMatch": "resourceGroup",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "location",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "apiVersion",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "snapshotType2",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "publicNetworkAccess",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "networkAccessPolicy",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "subscriptionId",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "tags",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "Details",
                          "formatter": 7,
                          "formatOptions": {
                            "linkTarget": "CellDetails",
                            "linkLabel": "ðŸ” View Details",
                            "linkIsContextBlade": true
                          }
                        }
                      ],
                      "rowLimit": 50,
                      "hierarchySettings": {
                        "treeType": 1,
                        "groupBy": [
                          "location"
                        ],
                        "expandTopLevel": true,
                        "finalBy": "snapshotType2"
                      },
                      "labelSettings": [
                        {
                          "columnId": "id",
                          "label": "Snapshot"
                        },
                        {
                          "columnId": "diskSizeGB",
                          "label": "Disk Size GB"
                        },
                        {
                          "columnId": "location",
                          "label": "Location"
                        },
                        {
                          "columnId": "sku",
                          "label": "Sku"
                        },
                        {
                          "columnId": "snapshotType",
                          "label": "Type"
                        },
                        {
                          "columnId": "snapshotType2",
                          "label": "Category"
                        }
                      ]
                    },
                    "sortBy": []
                  },
                  "name": "query - Snapshots for VM"
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "selectedTab",
              "comparison": "isEqualTo",
              "value": "VirtualMachines"
            },
            "name": "group - VMs Group"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "### Azure Snapshots Inventory Dashboard\r\n\r\nInventory dashboard for Azure Snaphots.",
                    "style": "upsell"
                  },
                  "name": "text - Inventory -Main Title"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "resources\r\n| where type == 'microsoft.compute/snapshots'\r\n| where resourceGroup in~ ({ResourceGroup:value})\r\n| where name in~ (split(\"{Snapshots:label}\", \", \"))\r\n| extend TimeCreated = properties.timeCreated\r\n| where TimeCreated >= {SnapshotAge:start} and TimeCreated <= {SnapshotAge:end}\r\n| summarize count() by type",
                    "size": 3,
                    "noDataMessage": "No resources found",
                    "queryType": 1,
                    "resourceType": "microsoft.resourcegraph/resources",
                    "crossComponentResources": [
                      "{Subscription}"
                    ],
                    "visualization": "tiles",
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "type",
                        "formatter": 16,
                        "formatOptions": {
                          "showIcon": true
                        }
                      },
                      "leftContent": {
                        "columnMatch": "count_",
                        "formatter": 12,
                        "formatOptions": {
                          "palette": "auto"
                        },
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "maximumSignificantDigits": 3,
                            "maximumFractionDigits": 2
                          }
                        }
                      },
                      "showBorder": true,
                      "sortCriteriaField": "count_",
                      "sortOrderField": 2
                    }
                  },
                  "name": "query - Inventory - All"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "resources \r\n| where type == \"microsoft.compute/snapshots\"\r\n| where resourceGroup in~ ({ResourceGroup:value})\r\n| where name in~ (split(\"{Snapshots:label}\", \", \"))\r\n| extend TimeCreated = properties.timeCreated\r\n| where TimeCreated >= {SnapshotAge:start} and TimeCreated <= {SnapshotAge:end}\r\n| summarize count(type) by subscriptionId",
                    "size": 3,
                    "title": "Count by Subscription Id",
                    "queryType": 1,
                    "resourceType": "microsoft.resourcegraph/resources",
                    "crossComponentResources": [
                      "{Subscription}"
                    ],
                    "visualization": "piechart",
                    "chartSettings": {
                      "showMetrics": false,
                      "showLegend": true
                    }
                  },
                  "customWidth": "25",
                  "name": "query - Inventory - Snapshots by Subscription Id"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "resources \r\n| where type == \"microsoft.compute/snapshots\"\r\n| where resourceGroup in~ ({ResourceGroup:value})\r\n| where name in~ (split(\"{Snapshots:label}\", \", \"))\r\n| extend TimeCreated = properties.timeCreated\r\n| where TimeCreated >= {SnapshotAge:start} and TimeCreated <= {SnapshotAge:end}\r\n| summarize count(type) by resourceGroup",
                    "size": 3,
                    "title": "Count by Resource Group",
                    "queryType": 1,
                    "resourceType": "microsoft.resourcegraph/resources",
                    "crossComponentResources": [
                      "{Subscription}"
                    ],
                    "visualization": "piechart",
                    "chartSettings": {
                      "showMetrics": false,
                      "showLegend": true
                    }
                  },
                  "customWidth": "25",
                  "name": "query - Inventory - Snapshots by Resource Group"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "resources \r\n| where type == \"microsoft.compute/snapshots\"\r\n| where resourceGroup in~ ({ResourceGroup:value})\r\n| where name in~ (split(\"{Snapshots:label}\", \", \"))\r\n| extend TimeCreated = properties.timeCreated\r\n| where TimeCreated >= {SnapshotAge:start} and TimeCreated <= {SnapshotAge:end}\r\n| summarize count(type) by location",
                    "size": 3,
                    "title": "Count by Location",
                    "queryType": 1,
                    "resourceType": "microsoft.resourcegraph/resources",
                    "crossComponentResources": [
                      "{Subscription}"
                    ],
                    "visualization": "piechart",
                    "tileSettings": {
                      "showBorder": false,
                      "titleContent": {
                        "columnMatch": "location",
                        "formatter": 1
                      },
                      "leftContent": {
                        "columnMatch": "count_type",
                        "formatter": 12,
                        "formatOptions": {
                          "palette": "auto"
                        },
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "maximumSignificantDigits": 3,
                            "maximumFractionDigits": 2
                          }
                        }
                      }
                    },
                    "chartSettings": {
                      "showMetrics": false,
                      "showLegend": true
                    }
                  },
                  "customWidth": "25",
                  "name": "query - Inventory - Snapshots by Location"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "resources \r\n| where type == \"microsoft.compute/snapshots\"\r\n| where resourceGroup in~ ({ResourceGroup:value})\r\n| where name in~ (split(\"{Snapshots:label}\", \", \"))\r\n| extend TimeCreated = properties.timeCreated\r\n| where TimeCreated >= {SnapshotAge:start} and TimeCreated <= {SnapshotAge:end}\r\n| extend sku = sku.name\r\n| summarize count(sku) by tostring(sku)",
                    "size": 3,
                    "title": "Count by Storage type",
                    "queryType": 1,
                    "resourceType": "microsoft.resourcegraph/resources",
                    "crossComponentResources": [
                      "{Subscription}"
                    ],
                    "visualization": "piechart",
                    "chartSettings": {
                      "showMetrics": false,
                      "showLegend": true
                    }
                  },
                  "customWidth": "25",
                  "name": "query - Inventory - Snapshots by SKU"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "resources \r\n| where type == \"microsoft.compute/snapshots\"\r\n| where resourceGroup in~ ({ResourceGroup:value})\r\n| where name in~ (split(\"{Snapshots:label}\", \", \"))\r\n| extend TimeCreated = properties.timeCreated\r\n| where TimeCreated >= {SnapshotAge:start} and TimeCreated <= {SnapshotAge:end}\r\n| extend diskSizeGB = properties.diskSizeGB\r\n| summarize count(diskSizeGB) by tostring(diskSizeGB)",
                    "size": 3,
                    "title": "Count by Source disk size (GiB)",
                    "queryType": 1,
                    "resourceType": "microsoft.resourcegraph/resources",
                    "crossComponentResources": [
                      "{Subscription}"
                    ],
                    "visualization": "piechart",
                    "chartSettings": {
                      "showMetrics": false,
                      "showLegend": true
                    }
                  },
                  "customWidth": "25",
                  "name": "query - Inventory - Snapshots by diskSizeGB"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "resources \r\n| where type == \"microsoft.compute/snapshots\"\r\n| where resourceGroup in~ ({ResourceGroup:value})\r\n| where name in~ (split(\"{Snapshots:label}\", \", \"))\r\n| extend TimeCreated = properties.timeCreated\r\n| where TimeCreated >= {SnapshotAge:start} and TimeCreated <= {SnapshotAge:end}\r\n| extend snapshotType = case(properties.incremental == true, \"Incremental\", properties.incremental == false, \"Full\", \"\")\r\n| summarize count(snapshotType) by tostring(snapshotType)",
                    "size": 3,
                    "title": "Count by Snapshot type",
                    "queryType": 1,
                    "resourceType": "microsoft.resourcegraph/resources",
                    "crossComponentResources": [
                      "{Subscription}"
                    ],
                    "visualization": "piechart",
                    "chartSettings": {
                      "showMetrics": false,
                      "showLegend": true
                    }
                  },
                  "customWidth": "25",
                  "name": "query - Inventory - Snapshots by incremental"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "resources \r\n| where type == \"microsoft.compute/snapshots\"\r\n| where resourceGroup in~ ({ResourceGroup:value})\r\n| where name in~ (split(\"{Snapshots:label}\", \", \"))\r\n| extend TimeCreated = properties.timeCreated\r\n| where TimeCreated >= {SnapshotAge:start} and TimeCreated <= {SnapshotAge:end}\r\n| extend diskState = properties.diskState\r\n| summarize count(diskState) by tostring(diskState)",
                    "size": 3,
                    "title": "Count by Disk State",
                    "queryType": 1,
                    "resourceType": "microsoft.resourcegraph/resources",
                    "crossComponentResources": [
                      "{Subscription}"
                    ],
                    "visualization": "piechart",
                    "chartSettings": {
                      "showMetrics": false,
                      "showLegend": true
                    }
                  },
                  "customWidth": "25",
                  "name": "query - Inventory - Snapshots by diskState"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "resources \r\n| where type == \"microsoft.compute/snapshots\"\r\n| where resourceGroup in~ ({ResourceGroup:value})\r\n| where name in~ (split(\"{Snapshots:label}\", \", \"))\r\n| extend TimeCreated = properties.timeCreated\r\n| where TimeCreated >= {SnapshotAge:start} and TimeCreated <= {SnapshotAge:end}\r\n| extend createOption = properties.creationData.createOption\r\n| summarize count(createOption) by tostring(createOption)",
                    "size": 3,
                    "title": "Count by Create Option",
                    "queryType": 1,
                    "resourceType": "microsoft.resourcegraph/resources",
                    "crossComponentResources": [
                      "{Subscription}"
                    ],
                    "visualization": "piechart",
                    "chartSettings": {
                      "showMetrics": false,
                      "showLegend": true
                    }
                  },
                  "customWidth": "25",
                  "name": "query - Inventory - Snapshots by createOption"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "resources \r\n| where type == \"microsoft.compute/snapshots\"\r\n| where resourceGroup in~ ({ResourceGroup:value})\r\n| where name in~ (split(\"{Snapshots:label}\", \", \"))\r\n| extend TimeCreated = properties.timeCreated\r\n| where TimeCreated >= {SnapshotAge:start} and TimeCreated <= {SnapshotAge:end}\r\n| summarize count(apiVersion) by tostring(apiVersion)",
                    "size": 3,
                    "title": "Count by Api Version",
                    "queryType": 1,
                    "resourceType": "microsoft.resourcegraph/resources",
                    "crossComponentResources": [
                      "{Subscription}"
                    ],
                    "visualization": "piechart",
                    "chartSettings": {
                      "showMetrics": false,
                      "showLegend": true
                    }
                  },
                  "customWidth": "25",
                  "name": "query - Inventory - Snapshots by apiVersion"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "resources \r\n| where type == \"microsoft.compute/snapshots\"\r\n| where resourceGroup in~ ({ResourceGroup:value})\r\n| where name in~ (split(\"{Snapshots:label}\", \", \"))\r\n| extend TimeCreated = properties.timeCreated\r\n| where TimeCreated >= {SnapshotAge:start} and TimeCreated <= {SnapshotAge:end}\r\n| extend publicNetworkAccess = properties.publicNetworkAccess\r\n| summarize count(publicNetworkAccess) by tostring(publicNetworkAccess)",
                    "size": 3,
                    "title": "Count by Public Network Access",
                    "queryType": 1,
                    "resourceType": "microsoft.resourcegraph/resources",
                    "crossComponentResources": [
                      "{Subscription}"
                    ],
                    "visualization": "piechart",
                    "chartSettings": {
                      "showMetrics": false,
                      "showLegend": true
                    }
                  },
                  "customWidth": "25",
                  "name": "query - Inventory - Snapshots by publicNetworkAccess"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "resources \r\n| where type == \"microsoft.compute/snapshots\"\r\n| where resourceGroup in~ ({ResourceGroup:value})\r\n| where name in~ (split(\"{Snapshots:label}\", \", \"))\r\n| extend TimeCreated = properties.timeCreated\r\n| where TimeCreated >= {SnapshotAge:start} and TimeCreated <= {SnapshotAge:end}\r\n| extend networkAccessPolicy = properties.networkAccessPolicy\r\n| summarize count(networkAccessPolicy) by tostring(networkAccessPolicy)",
                    "size": 3,
                    "title": "Count by Network Access Policy",
                    "queryType": 1,
                    "resourceType": "microsoft.resourcegraph/resources",
                    "crossComponentResources": [
                      "{Subscription}"
                    ],
                    "visualization": "piechart",
                    "chartSettings": {
                      "showMetrics": false,
                      "showLegend": true
                    }
                  },
                  "customWidth": "25",
                  "name": "query - Inventory - Snapshots by networkAccessPolicy"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "resources \r\n| where type == \"microsoft.compute/snapshots\"\r\n| where resourceGroup in~ ({ResourceGroup:value})\r\n| where name in~ (split(\"{Snapshots:label}\", \", \"))\r\n| extend TimeCreated = properties.timeCreated\r\n| where TimeCreated >= {SnapshotAge:start} and TimeCreated <= {SnapshotAge:end}\r\n| extend dataAccessAuthMode = properties.dataAccessAuthMode\r\n| summarize count(dataAccessAuthMode) by tostring(dataAccessAuthMode)",
                    "size": 3,
                    "title": "Count by Data Access Auth Mode",
                    "queryType": 1,
                    "resourceType": "microsoft.resourcegraph/resources",
                    "crossComponentResources": [
                      "{Subscription}"
                    ],
                    "visualization": "piechart",
                    "chartSettings": {
                      "showMetrics": false,
                      "showLegend": true
                    }
                  },
                  "customWidth": "25",
                  "name": "query - Inventory - Snapshots by dataAccessAuthMode"
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "selectedTab",
              "comparison": "isEqualTo",
              "value": "Inventory"
            },
            "name": "group - Inventory Group"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "### Azure Snapshots Insights Workbook\r\n\r\nThe purpose of this workbook is to provide an overview of your Azure Snapshots resources.",
                    "style": "upsell"
                  },
                  "name": "text - Summary -Main Title"
                },
                {
                  "type": 1,
                  "content": {
                    "json": "### Virtual Machines vs Snapshots"
                  },
                  "name": "text - 15"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "resources\r\n| where type == 'microsoft.compute/virtualmachines'\r\n| where resourceGroup in~ ({ResourceGroup:value})\r\n| extend title2 = 'Virtual machines'\r\n| summarize count() by title2",
                    "size": 3,
                    "noDataMessage": "No resources found",
                    "queryType": 1,
                    "resourceType": "microsoft.resourcegraph/resources",
                    "crossComponentResources": [
                      "{Subscription}"
                    ],
                    "visualization": "tiles",
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "title2",
                        "formatter": 1
                      },
                      "leftContent": {
                        "columnMatch": "count_",
                        "formatter": 12,
                        "formatOptions": {
                          "palette": "auto"
                        },
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "maximumSignificantDigits": 3,
                            "maximumFractionDigits": 2
                          }
                        }
                      },
                      "showBorder": true,
                      "sortCriteriaField": "count_",
                      "sortOrderField": 2
                    }
                  },
                  "customWidth": "25",
                  "name": "query - Summary - Virtual Machines"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "resources\r\n| where type == 'microsoft.compute/virtualmachines'\r\n| where resourceGroup in~ ({ResourceGroup:value})\r\n| where tags['smcp-backup'] == \"on\"\r\n| extend title2 = 'VMs with backup on'\r\n| summarize count() by title2",
                    "size": 3,
                    "noDataMessage": "No resources found",
                    "queryType": 1,
                    "resourceType": "microsoft.resourcegraph/resources",
                    "crossComponentResources": [
                      "{Subscription}"
                    ],
                    "visualization": "tiles",
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "title2",
                        "formatter": 1
                      },
                      "leftContent": {
                        "columnMatch": "count_",
                        "formatter": 12,
                        "formatOptions": {
                          "min": 0,
                          "palette": "green"
                        },
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "style": "decimal",
                            "maximumFractionDigits": 2,
                            "maximumSignificantDigits": 3
                          }
                        }
                      },
                      "showBorder": true,
                      "sortCriteriaField": "count_",
                      "sortOrderField": 2
                    }
                  },
                  "customWidth": "25",
                  "name": "query - Summary - Virtual Machines with backup"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "resources\r\n| where type == 'microsoft.compute/snapshots'\r\n| where resourceGroup in~ ({ResourceGroup:value})\r\n| where name in~ (split(\"{Snapshots:label}\", \", \"))\r\n| extend TimeCreated = properties.timeCreated\r\n| where TimeCreated >= {SnapshotAge:start} and TimeCreated <= {SnapshotAge:end}\r\n| extend SnapshotLocationType = tags[\"smcp-location-type\"]\r\n| summarize BackupSnapshots = make_set(SnapshotLocationType) by id\r\n| extend\r\nÂ    IsPrimary = BackupSnapshots has \"primary\",\r\nÂ    IsSecondary = BackupSnapshots has \"secondary\"\r\n| summarize\r\nÂ    PrimarySnapshots = countif(IsPrimary),\r\nÂ    SecondarySnapshots = countif(IsSecondary)\r\n| extend title2 = 'Backup Snapshots'\r\n| extend title3 = 'Primary Region'\r\n",
                    "size": 3,
                    "noDataMessage": "No resources found",
                    "queryType": 1,
                    "resourceType": "microsoft.resourcegraph/resources",
                    "crossComponentResources": [
                      "{Subscription}"
                    ],
                    "visualization": "tiles",
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "title2",
                        "formatter": 1
                      },
                      "subtitleContent": {
                        "columnMatch": "title3"
                      },
                      "leftContent": {
                        "columnMatch": "PrimarySnapshots",
                        "formatter": 12,
                        "formatOptions": {
                          "min": 0,
                          "palette": "magenta"
                        },
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "style": "decimal",
                            "maximumFractionDigits": 2,
                            "maximumSignificantDigits": 3
                          }
                        }
                      },
                      "showBorder": true,
                      "sortCriteriaField": "count_",
                      "sortOrderField": 2
                    }
                  },
                  "customWidth": "25",
                  "name": "query - Summary - Snapshots secondary"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "resources\r\n| where type == 'microsoft.compute/snapshots'\r\n| where resourceGroup in~ ({ResourceGroup:value})\r\n| where name in~ (split(\"{Snapshots:label}\", \", \"))\r\n| extend TimeCreated = properties.timeCreated\r\n| where TimeCreated >= {SnapshotAge:start} and TimeCreated <= {SnapshotAge:end}\r\n| extend SnapshotLocationType = tags[\"smcp-location-type\"]\r\n| summarize BackupSnapshots = make_set(SnapshotLocationType) by id\r\n| extend\r\nÂ    IsPrimary = BackupSnapshots has \"primary\",\r\nÂ    IsSecondary = BackupSnapshots has \"secondary\"\r\n| summarize\r\nÂ    PrimarySnapshots = countif(IsPrimary),\r\nÂ    SecondarySnapshots = countif(IsSecondary)\r\n| extend title2 = 'Backup Snapshots'\r\n| extend title3 = 'Secondary Region'\r\n",
                    "size": 3,
                    "noDataMessage": "No resources found",
                    "queryType": 1,
                    "resourceType": "microsoft.resourcegraph/resources",
                    "crossComponentResources": [
                      "{Subscription}"
                    ],
                    "visualization": "tiles",
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "title2",
                        "formatter": 1
                      },
                      "subtitleContent": {
                        "columnMatch": "title3"
                      },
                      "leftContent": {
                        "columnMatch": "SecondarySnapshots",
                        "formatter": 12,
                        "formatOptions": {
                          "min": 0,
                          "palette": "brown"
                        },
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "style": "decimal",
                            "maximumFractionDigits": 2,
                            "maximumSignificantDigits": 3
                          }
                        }
                      },
                      "showBorder": true,
                      "sortCriteriaField": "count_",
                      "sortOrderField": 2
                    }
                  },
                  "customWidth": "25",
                  "name": "query - Summary - Snapshots primary"
                },
                {
                  "type": 1,
                  "content": {
                    "json": "### Snapshots Backup Jobs"
                  },
                  "name": "text - 16"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "SnapshotsOperations_CL\r\n| where jobType == \"Snapshot\"\r\n| extend resourceGroup = extract(@\"/resourceGroups/([^/]+)\", 1, sourceVmId)\r\n| where resourceGroup in~ ({ResourceGroup:value})\r\n| where TimeGenerated >= {SnapshotAge:start} and TimeGenerated <= {SnapshotAge:end}\r\n| summarize Operations = make_set(jobStatus) by jobId\r\n| extend \r\n    IsCompleted = Operations has \"Snapshot Completed\" and not(Operations has \"Snapshot Failed\"),\r\n    IsInProgress = Operations has \"Snapshot In Progress\" and not(Operations has \"Snapshot Completed\") and not(Operations has \"Snapshot Failed\"),\r\n    IsFailed = Operations has \"Snapshot Failed\"\r\n| summarize \r\n    AllJobs = countif(IsCompleted) + countif(IsInProgress) + countif(IsFailed)\r\n| extend type = 'All backup jobs'",
                    "size": 3,
                    "noDataMessage": "No resources found",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{LogAnalyticsWorkspace}"
                    ],
                    "visualization": "tiles",
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "type",
                        "formatter": 1
                      },
                      "leftContent": {
                        "columnMatch": "AllJobs",
                        "formatter": 12,
                        "formatOptions": {
                          "palette": "auto"
                        },
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "style": "decimal",
                            "maximumFractionDigits": 2,
                            "maximumSignificantDigits": 3
                          }
                        }
                      },
                      "showBorder": true,
                      "sortCriteriaField": "count_",
                      "sortOrderField": 2
                    }
                  },
                  "customWidth": "25",
                  "name": "query - Summary - Backup Jobs"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "SnapshotsOperations_CL\r\n| where jobType == \"Snapshot\"\r\n| extend resourceGroup = extract(@\"/resourceGroups/([^/]+)\", 1, sourceVmId)\r\n| where resourceGroup in~ ({ResourceGroup:value})\r\n| where TimeGenerated >= {SnapshotAge:start} and TimeGenerated <= {SnapshotAge:end}\r\n| summarize Operations = make_set(jobStatus) by jobId\r\n| extend \r\n    IsCompleted = Operations has \"Snapshot Completed\" and not(Operations has \"Snapshot Failed\"),\r\n    IsInProgress = Operations has \"Snapshot In Progress\" and not(Operations has \"Snapshot Completed\") and not(Operations has \"Snapshot Failed\"),\r\n    IsFailed = Operations has \"Snapshot Failed\"\r\n| summarize \r\n    CompletedJobs = countif(IsCompleted),\r\n    InProgressJobs = countif(IsInProgress),\r\n    FailedJobs = countif(IsFailed)\r\n| extend type = 'Backup completed jobs'",
                    "size": 3,
                    "noDataMessage": "No resources found",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{LogAnalyticsWorkspace}"
                    ],
                    "visualization": "tiles",
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "type",
                        "formatter": 1
                      },
                      "leftContent": {
                        "columnMatch": "CompletedJobs",
                        "formatter": 12,
                        "formatOptions": {
                          "min": 0,
                          "palette": "green"
                        },
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "style": "decimal",
                            "maximumFractionDigits": 2,
                            "maximumSignificantDigits": 3
                          }
                        }
                      },
                      "showBorder": true,
                      "sortCriteriaField": "count_",
                      "sortOrderField": 2
                    }
                  },
                  "customWidth": "25",
                  "name": "query - Summary - Backup Completed Jobs"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "SnapshotsOperations_CL\r\n| where jobType == \"Snapshot\"\r\n| extend resourceGroup = extract(@\"/resourceGroups/([^/]+)\", 1, sourceVmId)\r\n| where resourceGroup in~ ({ResourceGroup:value})\r\n| where TimeGenerated >= {SnapshotAge:start} and TimeGenerated <= {SnapshotAge:end}\r\n| summarize Operations = make_set(jobStatus) by jobId\r\n| extend \r\n    IsCompleted = Operations has \"Snapshot Completed\" and not(Operations has \"Snapshot Failed\"),\r\n    IsInProgress = Operations has \"Snapshot In Progress\" and not(Operations has \"Snapshot Completed\") and not(Operations has \"Snapshot Failed\"),\r\n    IsFailed = Operations has \"Snapshot Failed\"\r\n| summarize \r\n    CompletedJobs = countif(IsCompleted),\r\n    InProgressJobs = countif(IsInProgress),\r\n    FailedJobs = countif(IsFailed)\r\n| extend type = 'Backup failed jobs'",
                    "size": 3,
                    "noDataMessage": "No resources found",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{LogAnalyticsWorkspace}"
                    ],
                    "visualization": "tiles",
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "type",
                        "formatter": 1
                      },
                      "leftContent": {
                        "columnMatch": "FailedJobs",
                        "formatter": 12,
                        "formatOptions": {
                          "min": 0,
                          "palette": "red"
                        },
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "style": "decimal",
                            "maximumFractionDigits": 2,
                            "maximumSignificantDigits": 3
                          }
                        }
                      },
                      "showBorder": true,
                      "sortCriteriaField": "count_",
                      "sortOrderField": 2
                    }
                  },
                  "customWidth": "25",
                  "name": "query - Summary - Backup Failed Jobs"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "SnapshotsOperations_CL\r\n| where jobType == \"Snapshot\"\r\n| extend resourceGroup = extract(@\"/resourceGroups/([^/]+)\", 1, sourceVmId)\r\n| where resourceGroup in~ ({ResourceGroup:value})\r\n| where TimeGenerated >= {SnapshotAge:start} and TimeGenerated <= {SnapshotAge:end}\r\n| summarize Operations = make_set(jobStatus) by jobId\r\n| extend \r\n    IsCompleted = Operations has \"Snapshot Completed\" and not(Operations has \"Snapshot Failed\"),\r\n    IsInProgress = Operations has \"Snapshot In Progress\" and not(Operations has \"Snapshot Completed\") and not(Operations has \"Snapshot Failed\"),\r\n    IsFailed = Operations has \"Snapshot Failed\"\r\n| summarize \r\n    CompletedJobs = countif(IsCompleted),\r\n    InProgressJobs = countif(IsInProgress),\r\n    FailedJobs = countif(IsFailed)\r\n| extend type = 'Backup in progress jobs'",
                    "size": 3,
                    "noDataMessage": "No resources found",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{LogAnalyticsWorkspace}"
                    ],
                    "visualization": "tiles",
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "type",
                        "formatter": 1
                      },
                      "leftContent": {
                        "columnMatch": "InProgressJobs",
                        "formatter": 12,
                        "formatOptions": {
                          "min": 0,
                          "palette": "yellow"
                        },
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "style": "decimal",
                            "maximumFractionDigits": 2,
                            "maximumSignificantDigits": 3
                          }
                        }
                      },
                      "showBorder": true,
                      "sortCriteriaField": "count_",
                      "sortOrderField": 2
                    }
                  },
                  "customWidth": "25",
                  "name": "query - Summary - Backup In Progress Jobs"
                },
                {
                  "type": 1,
                  "content": {
                    "json": "### Snapshots Purge Jobs"
                  },
                  "name": "text - 17"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "SnapshotsOperations_CL\r\n| where jobType == \"Purge\"\r\n| extend resourceGroup = extract(@\"/resourceGroups/([^/]+)\", 1, sourceVmId)\r\n| where resourceGroup in~ ({ResourceGroup:value})\r\n| where TimeGenerated >= {SnapshotAge:start} and TimeGenerated <= {SnapshotAge:end}\r\n| summarize Operations = make_set(jobStatus) by jobId\r\n| extend \r\n    IsCompleted = Operations has \"Purge Completed\" and not(Operations has \"Purge Failed\"),\r\n    IsInProgress = Operations has \"Purge In Progress\" and not(Operations has \"Purge Completed\") and not(Operations has \"Purge Failed\"),\r\n    IsFailed = Operations has \"Purge Failed\"\r\n| summarize \r\n    AllJobs = countif(IsCompleted) + countif(IsInProgress) + countif(IsFailed)\r\n| extend type = 'All purge jobs'",
                    "size": 3,
                    "noDataMessage": "No resources found",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{LogAnalyticsWorkspace}"
                    ],
                    "visualization": "tiles",
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "type",
                        "formatter": 1
                      },
                      "leftContent": {
                        "columnMatch": "AllJobs",
                        "formatter": 12,
                        "formatOptions": {
                          "palette": "auto"
                        },
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "style": "decimal",
                            "maximumFractionDigits": 2,
                            "maximumSignificantDigits": 3
                          }
                        }
                      },
                      "showBorder": true,
                      "sortCriteriaField": "count_",
                      "sortOrderField": 2
                    }
                  },
                  "customWidth": "25",
                  "name": "query - Summary - Purge Jobs"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "SnapshotsOperations_CL\r\n| where jobType == \"Purge\"\r\n| extend resourceGroup = extract(@\"/resourceGroups/([^/]+)\", 1, sourceVmId)\r\n| where resourceGroup in~ ({ResourceGroup:value})\r\n| where TimeGenerated >= {SnapshotAge:start} and TimeGenerated <= {SnapshotAge:end}\r\n| summarize Operations = make_set(jobStatus) by jobId\r\n| extend \r\n    IsCompleted = Operations has \"Purge Completed\" and not(Operations has \"Purge Failed\"),\r\n    IsInProgress = Operations has \"Purge In Progress\" and not(Operations has \"Purge Completed\") and not(Operations has \"Purge Failed\"),\r\n    IsFailed = Operations has \"Purge Failed\"\r\n| summarize \r\n    CompletedJobs = countif(IsCompleted),\r\n    InProgressJobs = countif(IsInProgress),\r\n    FailedJobs = countif(IsFailed)\r\n| extend type = 'Purge completed jobs'",
                    "size": 3,
                    "noDataMessage": "No resources found",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{LogAnalyticsWorkspace}"
                    ],
                    "visualization": "tiles",
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "type",
                        "formatter": 1
                      },
                      "leftContent": {
                        "columnMatch": "CompletedJobs",
                        "formatter": 12,
                        "formatOptions": {
                          "min": 0,
                          "palette": "green"
                        },
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "style": "decimal",
                            "maximumFractionDigits": 2,
                            "maximumSignificantDigits": 3
                          }
                        }
                      },
                      "showBorder": true,
                      "sortCriteriaField": "count_",
                      "sortOrderField": 2
                    }
                  },
                  "customWidth": "25",
                  "name": "query - Summary - Purge Completed Jobs"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "SnapshotsOperations_CL\r\n| where jobType == \"Purge\"\r\n| extend resourceGroup = extract(@\"/resourceGroups/([^/]+)\", 1, sourceVmId)\r\n| where resourceGroup in~ ({ResourceGroup:value})\r\n| where TimeGenerated >= {SnapshotAge:start} and TimeGenerated <= {SnapshotAge:end}\r\n| summarize Operations = make_set(jobStatus) by jobId\r\n| extend \r\n    IsCompleted = Operations has \"Purge Completed\" and not(Operations has \"Purge Failed\"),\r\n    IsInProgress = Operations has \"Purge In Progress\" and not(Operations has \"Purge Completed\") and not(Operations has \"Purge Failed\"),\r\n    IsFailed = Operations has \"Purge Failed\"\r\n| summarize \r\n    CompletedJobs = countif(IsCompleted),\r\n    InProgressJobs = countif(IsInProgress),\r\n    FailedJobs = countif(IsFailed)\r\n| extend type = 'Purge failed jobs'",
                    "size": 3,
                    "noDataMessage": "No resources found",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{LogAnalyticsWorkspace}"
                    ],
                    "visualization": "tiles",
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "type",
                        "formatter": 1
                      },
                      "leftContent": {
                        "columnMatch": "FailedJobs",
                        "formatter": 12,
                        "formatOptions": {
                          "min": 0,
                          "palette": "red"
                        },
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "style": "decimal",
                            "maximumFractionDigits": 2,
                            "maximumSignificantDigits": 3
                          }
                        }
                      },
                      "showBorder": true,
                      "sortCriteriaField": "count_",
                      "sortOrderField": 2
                    }
                  },
                  "customWidth": "25",
                  "name": "query - Summary - Purge Failed Jobs"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "SnapshotsOperations_CL\r\n| where jobType == \"Purge\"\r\n| extend resourceGroup = extract(@\"/resourceGroups/([^/]+)\", 1, sourceVmId)\r\n| where resourceGroup in~ ({ResourceGroup:value})\r\n| where TimeGenerated >= {SnapshotAge:start} and TimeGenerated <= {SnapshotAge:end}\r\n| summarize Operations = make_set(jobStatus) by jobId\r\n| extend \r\n    IsCompleted = Operations has \"Purge Completed\" and not(Operations has \"Purge Failed\"),\r\n    IsInProgress = Operations has \"Purge In Progress\" and not(Operations has \"Purge Completed\") and not(Operations has \"Purge Failed\"),\r\n    IsFailed = Operations has \"Purge Failed\"\r\n| summarize \r\n    CompletedJobs = countif(IsCompleted),\r\n    InProgressJobs = countif(IsInProgress),\r\n    FailedJobs = countif(IsFailed)\r\n| extend type = 'Purge in progress jobs'",
                    "size": 3,
                    "noDataMessage": "No resources found",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{LogAnalyticsWorkspace}"
                    ],
                    "visualization": "tiles",
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "type",
                        "formatter": 1
                      },
                      "leftContent": {
                        "columnMatch": "InProgressJobs",
                        "formatter": 12,
                        "formatOptions": {
                          "min": 0,
                          "palette": "yellow"
                        },
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "style": "decimal",
                            "maximumFractionDigits": 2,
                            "maximumSignificantDigits": 3
                          }
                        }
                      },
                      "showBorder": true,
                      "sortCriteriaField": "count_",
                      "sortOrderField": 2
                    }
                  },
                  "customWidth": "25",
                  "name": "query - Summary - Purge In Progress Jobs"
                },
                {
                  "type": 1,
                  "content": {
                    "json": "### Snapshots per Location and Disk Size"
                  },
                  "name": "text - 18"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "resources \r\n| where type == \"microsoft.compute/snapshots\"\r\n| where resourceGroup in~ ({ResourceGroup:value})\r\n| where name in~ (split(\"{Snapshots:label}\", \", \"))\r\n| extend TimeCreated = properties.timeCreated\r\n| where TimeCreated >= {SnapshotAge:start} and TimeCreated <= {SnapshotAge:end}\r\n| summarize count(type) by location",
                    "size": 3,
                    "title": "Snapshots Count by Location",
                    "queryType": 1,
                    "resourceType": "microsoft.resourcegraph/resources",
                    "crossComponentResources": [
                      "{Subscription}"
                    ],
                    "visualization": "piechart",
                    "tileSettings": {
                      "showBorder": false,
                      "titleContent": {
                        "columnMatch": "location",
                        "formatter": 1
                      },
                      "leftContent": {
                        "columnMatch": "count_type",
                        "formatter": 12,
                        "formatOptions": {
                          "palette": "auto"
                        },
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "maximumSignificantDigits": 3,
                            "maximumFractionDigits": 2
                          }
                        }
                      }
                    },
                    "chartSettings": {
                      "showMetrics": false,
                      "showLegend": true
                    }
                  },
                  "customWidth": "50",
                  "name": "query - Inventory - Snapshots by Location"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "resources \r\n| where type == \"microsoft.compute/snapshots\"\r\n| where resourceGroup in~ ({ResourceGroup:value})\r\n| where name in~ (split(\"{Snapshots:label}\", \", \"))\r\n| extend TimeCreated = properties.timeCreated\r\n| where TimeCreated >= {SnapshotAge:start} and TimeCreated <= {SnapshotAge:end}\r\n| extend diskSizeGB = properties.diskSizeGB\r\n| summarize count(diskSizeGB) by tostring(diskSizeGB)",
                    "size": 3,
                    "title": "Snapshots Count by Source disk size (GiB)",
                    "queryType": 1,
                    "resourceType": "microsoft.resourcegraph/resources",
                    "crossComponentResources": [
                      "{Subscription}"
                    ],
                    "visualization": "piechart",
                    "chartSettings": {
                      "showMetrics": false,
                      "showLegend": true
                    }
                  },
                  "customWidth": "50",
                  "name": "query - Inventory - Snapshots by diskSizeGB"
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "selectedTab",
              "comparison": "isEqualTo",
              "value": "Summary"
            },
            "name": "group - Summary Group"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "### Azure Snapshots Purge Jobs\r\n\r\nOverview dashboard for Azure Snaphots Purge Jobs.\r\n",
                    "style": "upsell"
                  },
                  "name": "text - Main Title"
                },
                {
                  "type": 9,
                  "content": {
                    "version": "KqlParameterItem/1.0",
                    "crossComponentResources": [
                      "/subscriptions/111-111-111/resourceGroups/xpto"
                    ],
                    "parameters": [
                      {
                        "id": "c4c76b07-a0b9-48ca-9a8b-2d5df3d5e2f0",
                        "version": "KqlParameterItem/1.0",
                        "name": "PurgeSourceVmName",
                        "label": "Virtual Machine name",
                        "type": 1,
                        "description": "Filter purge jobs by virtual machine",
                        "typeSettings": {
                          "isSearchBox": true
                        },
                        "timeContext": {
                          "durationMs": 86400000
                        },
                        "value": ""
                      },
                      {
                        "id": "b15e26b4-9f01-4746-a244-a425ce88cd4b",
                        "version": "KqlParameterItem/1.0",
                        "name": "PurgeJobStatus",
                        "label": "Job Status",
                        "type": 2,
                        "multiSelect": true,
                        "quote": "'",
                        "delimiter": ",",
                        "typeSettings": {
                          "additionalResourceOptions": []
                        },
                        "jsonData": "[\r\n    { \"value\":\"Purge Completed\", \"label\": \"Purge Completed\"},\r\n    { \"value\":\"Purge Failed\", \"label\": \"Purge Failed\"}\r\n]",
                        "timeContext": {
                          "durationMs": 86400000
                        },
                        "value": [
                          "Purge Failed"
                        ]
                      }
                    ],
                    "style": "above",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces"
                  },
                  "name": "purge jobs - parameters"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let FirstOps = SnapshotsOperations_CL\r\n| where jobType == \"Purge\" \r\n| where TimeGenerated >= {SnapshotAge:start} and TimeGenerated <= {SnapshotAge:end}\r\n| where jobStatus in~ (split(\"{PurgeJobStatus:label}\", \", \"))\r\n| extend vmName = tostring(split(sourceVmId, \"/\")[8])\r\n| where isempty('{PurgeSourceVmName:value}') or tolower(vmName) contains tolower(tostring('{PurgeSourceVmName:value}'))\r\n| summarize arg_min(TimeGenerated, *) by jobId;\r\n\r\nSnapshotsOperations_CL\r\n| join kind=inner (FirstOps) on jobId\r\n| where jobType == \"Purge\" \r\n| where TimeGenerated >= {SnapshotAge:start} and TimeGenerated <= {SnapshotAge:end}\r\n| summarize arg_max(TimeGenerated, *) by jobId\r\n| extend DurationMinutes = todouble(TimeGenerated - TimeGenerated1) / 600000000.0\r\n| project TimeGenerated, jobId, jobStatus, DurationMinutes, sourceVm = sourceVmId, sourceDisk = sourceDiskId, temporarySnapshot = primarySnapshotId, backupSnapshot = secondarySnapshotId, sourceLocation = primaryLocation, backupLocation = secondaryLocation\r\n| sort by TimeGenerated desc",
                    "size": 3,
                    "exportFieldName": "jobId",
                    "exportParameterName": "SelectedJob",
                    "showExportToExcel": true,
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{LogAnalyticsWorkspace}"
                    ],
                    "visualization": "table",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "TimeGenerated",
                          "formatter": 6,
                          "dateFormat": {
                            "showUtcTime": null,
                            "formatName": "shortDateTimeNoMsPattern"
                          }
                        },
                        {
                          "columnMatch": "jobStatus",
                          "formatter": 18,
                          "formatOptions": {
                            "thresholdsOptions": "icons",
                            "thresholdsGrid": [
                              {
                                "operator": "==",
                                "thresholdValue": "Purge Completed",
                                "representation": "success",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "==",
                                "thresholdValue": "Purge In Progress",
                                "representation": "pending",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "==",
                                "thresholdValue": "Purge Failed",
                                "representation": "3",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "Default",
                                "thresholdValue": null,
                                "representation": "unknown",
                                "text": "{0}{1}"
                              }
                            ]
                          }
                        },
                        {
                          "columnMatch": "DurationMinutes",
                          "formatter": 0,
                          "numberFormat": {
                            "unit": 25,
                            "options": {
                              "style": "decimal",
                              "maximumFractionDigits": 1
                            }
                          }
                        }
                      ],
                      "rowLimit": 100,
                      "filter": true,
                      "sortBy": [
                        {
                          "itemKey": "$gen_date_TimeGenerated_0",
                          "sortOrder": 2
                        }
                      ],
                      "labelSettings": [
                        {
                          "columnId": "TimeGenerated",
                          "label": "Date Time"
                        },
                        {
                          "columnId": "jobId",
                          "label": "Job ID"
                        },
                        {
                          "columnId": "jobStatus",
                          "label": "Job Status"
                        },
                        {
                          "columnId": "DurationMinutes",
                          "label": "Duration"
                        },
                        {
                          "columnId": "sourceVm",
                          "label": "Source VM"
                        },
                        {
                          "columnId": "sourceDisk",
                          "label": "Source Disk"
                        },
                        {
                          "columnId": "temporarySnapshot",
                          "label": "Primary Backup Snapshot"
                        },
                        {
                          "columnId": "backupSnapshot",
                          "label": "Secondary Backup Snapshot"
                        },
                        {
                          "columnId": "sourceLocation",
                          "label": "Source Location"
                        },
                        {
                          "columnId": "backupLocation",
                          "label": "Backup Location"
                        }
                      ]
                    },
                    "sortBy": [
                      {
                        "itemKey": "$gen_date_TimeGenerated_0",
                        "sortOrder": 2
                      }
                    ]
                  },
                  "name": "query - All Purge Jobs"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "SnapshotsOperations_CL\r\n| where jobId == \"{SelectedJob}\"\r\n| where jobType == \"Purge\"\r\n| extend Details = pack_all()\r\n| project TimeGenerated, jobId, jobOperation, jobStatus, message, sourceVm = sourceVmId, sourceDisk = sourceDiskId, temporarySnapshot = primarySnapshotId, backupSnapshot = secondarySnapshotId, sourceLocation = primaryLocation, backupLocation = secondaryLocation, Details\r\n| sort by TimeGenerated desc",
                    "size": 0,
                    "title": "Job Operations Details",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{LogAnalyticsWorkspace}"
                    ],
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "$gen_group",
                          "formatter": 6,
                          "dateFormat": {
                            "formatName": "shortDateTimeNoMsPattern"
                          }
                        },
                        {
                          "columnMatch": "TimeGenerated",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "jobId",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "jobOperation",
                          "formatter": 18,
                          "formatOptions": {
                            "thresholdsOptions": "icons",
                            "thresholdsGrid": [
                              {
                                "operator": "==",
                                "thresholdValue": "Secondary Snapshot Purge End",
                                "representation": "Stop",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "==",
                                "thresholdValue": "Primary Snapshot Purge Start",
                                "representation": "Start",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "==",
                                "thresholdValue": "Secondary Snapshot Purge Start",
                                "representation": "Start",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "==",
                                "thresholdValue": "Primary Snapshot Purge End",
                                "representation": "Stop",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "==",
                                "thresholdValue": "Error",
                                "representation": "cancelled",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "Default",
                                "thresholdValue": null,
                                "representation": "unknown",
                                "text": "{0}{1}"
                              }
                            ]
                          }
                        },
                        {
                          "columnMatch": "jobStatus",
                          "formatter": 18,
                          "formatOptions": {
                            "thresholdsOptions": "icons",
                            "thresholdsGrid": [
                              {
                                "operator": "==",
                                "thresholdValue": "Purge Completed",
                                "representation": "success",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "==",
                                "thresholdValue": "Purge Failed",
                                "representation": "3",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "==",
                                "thresholdValue": "Purge In Progress",
                                "representation": "pending",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "Default",
                                "thresholdValue": null,
                                "representation": "unknown",
                                "text": "{0}{1}"
                              }
                            ]
                          }
                        },
                        {
                          "columnMatch": "sourceVm",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "sourceDisk",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "temporarySnapshot",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "backupSnapshot",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "sourceLocation",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "backupLocation",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "Details",
                          "formatter": 7,
                          "formatOptions": {
                            "linkTarget": "CellDetails",
                            "linkLabel": "ðŸ” View Details",
                            "linkIsContextBlade": true
                          }
                        }
                      ],
                      "rowLimit": 50,
                      "hierarchySettings": {
                        "treeType": 1,
                        "groupBy": [
                          "jobId"
                        ],
                        "expandTopLevel": true,
                        "finalBy": "TimeGenerated"
                      },
                      "labelSettings": [
                        {
                          "columnId": "TimeGenerated",
                          "label": "Date time"
                        },
                        {
                          "columnId": "jobId",
                          "label": "Job ID"
                        },
                        {
                          "columnId": "jobOperation",
                          "label": "Operation"
                        },
                        {
                          "columnId": "jobStatus",
                          "label": "Status"
                        },
                        {
                          "columnId": "message",
                          "label": "Message"
                        }
                      ]
                    },
                    "sortBy": []
                  },
                  "name": "query - Job Operations"
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "selectedTab",
              "comparison": "isEqualTo",
              "value": "PurgeJobs"
            },
            "name": "group - Purge Group"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "### Azure Snapshots Backup Jobs\r\n\r\nOverview dashboard for Azure Snaphots Backup Jobs.\r\n",
                    "style": "upsell"
                  },
                  "name": "text - Main Title"
                },
                {
                  "type": 9,
                  "content": {
                    "version": "KqlParameterItem/1.0",
                    "crossComponentResources": [
                      "/subscriptions/111-111-111/resourceGroups/xpto"
                    ],
                    "parameters": [
                      {
                        "id": "4c8eafae-2513-452f-bab8-082250027f58",
                        "version": "KqlParameterItem/1.0",
                        "name": "SourceVmName",
                        "label": "Virtual Machine name",
                        "type": 1,
                        "description": "Filter the backup jobs",
                        "typeSettings": {
                          "isSearchBox": true
                        },
                        "value": ""
                      },
                      {
                        "id": "bf800817-0f5d-4bfe-b5be-a6226d5da613",
                        "version": "KqlParameterItem/1.0",
                        "name": "JobStatusFilter",
                        "label": "Job Status",
                        "type": 2,
                        "multiSelect": true,
                        "quote": "'",
                        "delimiter": ",",
                        "typeSettings": {
                          "additionalResourceOptions": [],
                          "showDefault": false
                        },
                        "jsonData": "[\r\n    { \"value\":\"Snapshot Completed\", \"label\": \"Snapshot Completed\"},\r\n    { \"value\":\"Snapshot Failed\", \"label\": \"Snapshot Failed\"}\r\n]",
                        "timeContext": {
                          "durationMs": 86400000
                        },
                        "value": [
                          "Snapshot Failed"
                        ]
                      }
                    ],
                    "style": "above",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces"
                  },
                  "name": "backup jobs - parameters"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let FirstOps = SnapshotsOperations_CL\r\n| where jobType == \"Snapshot\" \r\n| where TimeGenerated >= {SnapshotAge:start} and TimeGenerated <= {SnapshotAge:end}\r\n| where jobStatus in~ (split(\"{JobStatusFilter:label}\", \", \"))\r\n| extend vmName = tostring(split(sourceVmId, \"/\")[8])\r\n| where isempty('{SourceVmName:value}') or tolower(vmName) contains tolower(tostring('{SourceVmName:value}'))\r\n| summarize arg_min(TimeGenerated, *) by jobId;\r\n\r\nSnapshotsOperations_CL\r\n| join kind=inner (FirstOps) on jobId\r\n| where jobType == \"Snapshot\" \r\n| where TimeGenerated >= {SnapshotAge:start} and TimeGenerated <= {SnapshotAge:end}\r\n| where jobStatus in~ (split(\"{JobStatusFilter:label}\", \", \"))\r\n| summarize arg_max(TimeGenerated, *) by jobId\r\n| extend DurationMinutes = todouble(TimeGenerated - TimeGenerated1) / 600000000.0\r\n| project TimeGenerated, jobId, jobStatus, DurationMinutes, sourceVm = sourceVmId, sourceDisk = sourceDiskId, temporarySnapshot = primarySnapshotId, backupSnapshot = secondarySnapshotId, sourceLocation = primaryLocation, backupLocation = secondaryLocation\r\n| sort by TimeGenerated desc",
                    "size": 3,
                    "exportFieldName": "jobId",
                    "exportParameterName": "SelectedJob",
                    "showExportToExcel": true,
                    "exportToExcelOptions": "all",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{LogAnalyticsWorkspace}"
                    ],
                    "visualization": "table",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "TimeGenerated",
                          "formatter": 6,
                          "dateFormat": {
                            "showUtcTime": null,
                            "formatName": "shortDateTimeNoMsPattern"
                          }
                        },
                        {
                          "columnMatch": "jobStatus",
                          "formatter": 18,
                          "formatOptions": {
                            "thresholdsOptions": "icons",
                            "thresholdsGrid": [
                              {
                                "operator": "==",
                                "thresholdValue": "Snapshot Completed",
                                "representation": "success",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "==",
                                "thresholdValue": "Snapshot In Progress",
                                "representation": "pending",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "==",
                                "thresholdValue": "Snapshot Failed",
                                "representation": "3",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "Default",
                                "thresholdValue": null,
                                "representation": "unknown",
                                "text": "{0}{1}"
                              }
                            ]
                          }
                        },
                        {
                          "columnMatch": "DurationMinutes",
                          "formatter": 0,
                          "numberFormat": {
                            "unit": 25,
                            "options": {
                              "style": "decimal",
                              "maximumFractionDigits": 1
                            }
                          }
                        }
                      ],
                      "rowLimit": 50,
                      "sortBy": [
                        {
                          "itemKey": "$gen_date_TimeGenerated_0",
                          "sortOrder": 2
                        }
                      ],
                      "labelSettings": [
                        {
                          "columnId": "TimeGenerated",
                          "label": "Date Time"
                        },
                        {
                          "columnId": "jobId",
                          "label": "Job ID"
                        },
                        {
                          "columnId": "jobStatus",
                          "label": "Job Status"
                        },
                        {
                          "columnId": "DurationMinutes",
                          "label": "Duration"
                        },
                        {
                          "columnId": "sourceVm",
                          "label": "Source VM"
                        },
                        {
                          "columnId": "sourceDisk",
                          "label": "Source Disk"
                        },
                        {
                          "columnId": "temporarySnapshot",
                          "label": "Primary Backup Snapshot"
                        },
                        {
                          "columnId": "backupSnapshot",
                          "label": "Secondary Backup Snapshot"
                        },
                        {
                          "columnId": "sourceLocation",
                          "label": "Source Location"
                        },
                        {
                          "columnId": "backupLocation",
                          "label": "Backup Location"
                        }
                      ]
                    },
                    "sortBy": [
                      {
                        "itemKey": "$gen_date_TimeGenerated_0",
                        "sortOrder": 2
                      }
                    ]
                  },
                  "name": "query - All Backup Jobs"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "SnapshotsOperations_CL\r\n| where jobId == \"{SelectedJob}\"\r\n| where jobType == \"Snapshot\"\r\n| extend Details = pack_all()\r\n| project TimeGenerated, jobId, jobOperation, jobStatus, message, sourceVm = sourceVmId, sourceDisk = sourceDiskId, temporarySnapshot = primarySnapshotId, backupSnapshot = secondarySnapshotId, sourceLocation = primaryLocation, backupLocation = secondaryLocation, Details\r\n| sort by TimeGenerated desc",
                    "size": 0,
                    "title": "Job Operations Details",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{LogAnalyticsWorkspace}"
                    ],
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "$gen_group",
                          "formatter": 6,
                          "dateFormat": {
                            "formatName": "shortDateTimeNoMsPattern"
                          }
                        },
                        {
                          "columnMatch": "TimeGenerated",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "jobId",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "jobOperation",
                          "formatter": 18,
                          "formatOptions": {
                            "thresholdsOptions": "icons",
                            "thresholdsGrid": [
                              {
                                "operator": "==",
                                "thresholdValue": "Start",
                                "representation": "Start",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "==",
                                "thresholdValue": "Snapshot Create",
                                "representation": "Save",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "==",
                                "thresholdValue": "Error",
                                "representation": "cancelled",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "==",
                                "thresholdValue": "Snapshot Copy Start",
                                "representation": "Start",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "==",
                                "thresholdValue": "Snapshot Copy End",
                                "representation": "Stop",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "Default",
                                "thresholdValue": null,
                                "representation": "unknown",
                                "text": "{0}{1}"
                              }
                            ]
                          }
                        },
                        {
                          "columnMatch": "jobStatus",
                          "formatter": 18,
                          "formatOptions": {
                            "thresholdsOptions": "icons",
                            "thresholdsGrid": [
                              {
                                "operator": "==",
                                "thresholdValue": "Snapshot In Progress",
                                "representation": "pending",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "==",
                                "thresholdValue": "Snapshot Completed",
                                "representation": "success",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "==",
                                "thresholdValue": "Snapshot Failed",
                                "representation": "3",
                                "text": "{0}{1}"
                              },
                              {
                                "operator": "Default",
                                "thresholdValue": null,
                                "representation": "unknown",
                                "text": "{0}{1}"
                              }
                            ]
                          }
                        },
                        {
                          "columnMatch": "sourceVm",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "sourceDisk",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "temporarySnapshot",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "backupSnapshot",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "sourceLocation",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "backupLocation",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "Details",
                          "formatter": 7,
                          "formatOptions": {
                            "linkTarget": "CellDetails",
                            "linkLabel": "ðŸ” View Details",
                            "linkIsContextBlade": true
                          }
                        }
                      ],
                      "rowLimit": 50,
                      "hierarchySettings": {
                        "treeType": 1,
                        "groupBy": [
                          "jobId"
                        ],
                        "expandTopLevel": true,
                        "finalBy": "TimeGenerated"
                      },
                      "labelSettings": [
                        {
                          "columnId": "TimeGenerated",
                          "label": "Date time"
                        },
                        {
                          "columnId": "jobId",
                          "label": "Job ID"
                        },
                        {
                          "columnId": "jobOperation",
                          "label": "Operation"
                        },
                        {
                          "columnId": "jobStatus",
                          "label": "Status"
                        },
                        {
                          "columnId": "message",
                          "label": "Message"
                        }
                      ]
                    },
                    "sortBy": []
                  },
                  "name": "query - Backup Job Operations"
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "selectedTab",
              "comparison": "isEqualTo",
              "value": "BackupJobs"
            },
            "name": "group - Backup Group"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Subscription",
        "comparison": "isNotEqualTo"
      },
      "name": "group - Azure Snapshots"
    }
  ],
  "fallbackResourceIds": [
    "/subscriptions/111-111-111/resourceGroups/xpto"
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}